!function(t){function i(t){this.c=t,this.w=t.width,this.h=t.height,this.centerX=this.w/2,this.centerY=this.h/2,this.ctx=t.getContext("2d"),this.init()}var e=Math.PI;i.prototype={constructor:i,init:function(){this.initPoints(),this.initLines(),this.initControls(),this.drawBase(),this.totalFrames=200,this.drawCurve()},initPoints:function(){var t=~~(Math.min(this.w,this.h)/3);this.points=[{x:this.centerX-t,y:this.centerY-t/2},{x:this.centerX-t,y:this.centerY+t/2},{x:this.centerX,y:this.centerY+t/2},{x:this.centerX,y:this.centerY-t/2},{x:this.centerX+t,y:this.centerY-t/2},{x:this.centerX+t,y:this.centerY+t/2}],this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.pointR=~~(t/25),this.pointBg="rgba(0,0,0,.8)",this.pointBorder="#fe0066",this.pointFont=this.pointR+'px "Microsoft Yahei"',this.pointFontColor="#fff",this.pathPoint={bg:"#333",r:~~(t/30)}},initLines:function(){this.mainLineColor="#333",this.mainLineWidth=(this.pointR/2).toFixed(1),this.guideLineWidth=1,this.curveWidth=~~(2*this.mainLineWidth),this.curveColor="#333",this.colorR=80,this.colorG=100,this.colorB=180,this.speedR=25,this.speedG=20,this.speedB=30,this.ctx.lineJoin="round"},initControls:function(){var t=this;this.c.addEventListener("mousemove",function(i){t.isDragging||(t.selectedPoint=t.detect(i.offsetX,i.offsetY),t.selectedPoint?t.c.style.cursor="pointer":t.c.style.cursor="auto")},!1),this.c.addEventListener("mousedown",function(i){function e(i){var e=i.clientX-s,h=i.clientY-n;0>e&&(e=0)||e>t.w&&(e=t.w),0>h&&(h=0)||h>t.h&&(h=t.h),t.selectedPoint.x=e,t.selectedPoint.y=h,t.drawBase()}if(2!==i.button&&t.selectedPoint){var s=i.clientX-t.selectedPoint.x,n=i.clientY-t.selectedPoint.y;t.clearCurve(),t.isDragging=!0,t.c.style.cursor="move",i.preventDefault(),document.addEventListener("mousemove",e,!1),document.addEventListener("mouseup",function h(){t.c.style.cursor="auto",t.isDragging=!1,t.drawCurve(),document.removeEventListener("mousemove",e),document.removeEventListener("mouseup",h)},!1)}},!1),this.initContextMenu()},initContextMenu:function(){var t=this;this.menu=document.createElement("ul"),this.menu.id="c-menu",this.menu.innerHTML="<li>增加一个点</li><li>减少一个点</li>",this.menu.style.display="block",document.body.appendChild(this.menu),this.menuWidth=this.menu.offsetWidth,this.menuHeight=this.menu.offsetHeight,this.menu.style.display="none",console.log(this.menuWidth),this.c.addEventListener("contextmenu",function(i){i.preventDefault();var e=i.clientX,s=i.clientY;e+t.menuWidth>document.documentElement.clientWidth&&(e-=t.menuWidth),s+t.menuHeight>document.documentElement.clientHeight&&(s-=t.menuHeight),t.showMenu(e,s),t.menuX=i.offsetX,t.menuY=i.offsetY},!1),this.menu.addEventListener("click",function(i){"LI"===i.target.tagName&&"c-li-act"===i.target.className&&(t.clearCurve(),i.target===t.menu.children[0]?t.points.push({x:t.menuX,y:t.menuY}):t.points.splice(t.selectedPointIdx,1),t.hideMenu(),t.drawBase(),t.drawCurve())},!1),document.addEventListener("click",function(i){t.menu.contains(i.target)||t.hideMenu()},!1)},showMenu:function(t,i){this.menu.style.left=t+"px",this.menu.style.top=i+"px",this.menu.style.display="block",this.menu.children[0].className=this.selectedPoint?"":"c-li-act",this.menu.children[1].className=this.selectedPoint&&this.points.length>2?"c-li-act":""},hideMenu:function(){this.menu.style.display="none"},detect:function(t,i){for(var s,n=0;n<this.points.length;n++)if(s=this.points[n],this.ctx.beginPath(),this.ctx.arc(s.x,s.y,this.pointR,0,2*e,!1),this.ctx.isPointInPath(t,i))return this.selectedPointIdx=n,s;return null},drawLines:function(){this.ctx.beginPath(),this.ctx.save(),this.ctx.lineWidth=this.mainLineWidth,this.ctx.strokeStyle=this.mainLineColor,this.ctx.moveTo(this.points[0].x,this.points[0].y);for(var t=1;t<this.points.length;t++)this.ctx.lineTo(this.points[t].x,this.points[t].y);this.ctx.stroke(),this.ctx.restore()},drawPoints:function(){var t;this.ctx.save(),this.ctx.font=this.pointFont,this.ctx.lineWidth=1,this.ctx.strokeStyle=this.pointBorder;for(var i=0;i<this.points.length;i++)this.ctx.beginPath(),t=this.points[i],this.ctx.arc(t.x,t.y,this.pointR,0,2*e,!1),this.ctx.fillStyle=this.pointBg,this.ctx.fill(),this.ctx.stroke(),this.ctx.fillStyle=this.pointFontColor,this.ctx.fillText(i,t.x,t.y);this.ctx.restore()},justifyColor:function(t){var i=["color"+t],e=["speed"+t];this[i]+=this[e],this[i]>=200?(this[i]=200,this[e]*=-1):this[i]<=40&&(this[i]=40,this[e]*=-1)},colorGrow:function(){return this.justifyColor("R"),this.justifyColor("G"),this.justifyColor("B"),"rgb("+this.colorR+","+this.colorG+","+this.colorB+")"},resolveGLColors:function(){this.GLColors=[];for(var t=0;t<this.points.length-2;t++)this.GLColors.push(this.colorGrow())},calcLoc:function(t,i){return{x:(i.x-t.x)*this.progress+t.x,y:(i.y-t.y)*this.progress+t.y}},drawGuideLines:function(t){var i,s,n,h=[];if(t.length>2){this.ctx.beginPath(),this.ctx.strokeStyle=this.ctx.fillStyle=this.GLColors[this.GLColorIdx++],i=t[0],s=t[1],n=this.calcLoc(i,s),this.ctx.moveTo(n.x,n.y),h.push(n);for(var o=2;o<t.length;o++)i=s,s=t[o],n=this.calcLoc(i,s),this.ctx.lineTo(n.x,n.y),h.push(n);this.ctx.stroke(),this.drawGuideLines(h)}else i=t[0],s=t[1],n=this.calcLoc(i,s),this.ctx.beginPath(),this.ctx.fillStyle=this.pathPoint.bg,this.ctx.arc(n.x,n.y,this.pathPoint.r,0,2*e,!1),this.ctx.fill(),this.curvePath.push(n),this.drawCurvePath()},drawCurvePath:function(){this.ctx.beginPath(),this.ctx.save(),this.ctx.strokeStyle=this.curveColor,this.ctx.lineWidth=this.curveWidth,this.ctx.moveTo(this.curvePath[0].x,this.curvePath[0].y);for(var t=1;t<this.curvePath.length;t++)this.ctx.lineTo(this.curvePath[t].x,this.curvePath[t].y);this.ctx.stroke(),this.ctx.restore()},drawProcess:function(){var t=this;this.curFrame++,this.progress=this.curFrame/this.totalFrames,this.ctx.putImageData(this.img,0,0),this.ctx.lineWidth=this.guideLineWidth,this.drawGuideLines(this.points),this.GLColorIdx=0,this.curFrame<this.totalFrames&&(this.curveTimer=requestAnimationFrame(function(){t.drawProcess()}))},drawCurve:function(){this.drawBase(),this.img=this.ctx.getImageData(0,0,this.w,this.h),this.curFrame=-1,this.curvePath=[],this.resolveGLColors(),this.drawProcess()},clearCurve:function(){cancelAnimationFrame(this.curveTimer),this.drawBase()},drawBase:function(){this.ctx.clearRect(0,0,this.w,this.h),this.drawLines(),this.drawPoints()}},t.BezierDemo=i}(window);