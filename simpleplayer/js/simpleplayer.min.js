!function(t){function i(t){return t=~~t,10>t?"0"+t:""+t}function s(t,i){return Math.floor(Math.random()*(i-t)+t)}function e(t,i){this.canvas=t,this.musics=i||[],this.curMusic=0,this.init()}var h=/firefox/i.test(t.navigator.userAgent),n=h?function(t,i){t.addEventListener("DOMMouseScroll",function(s){i.call(t,s.detail>0)},!1)}:function(t,i){t.addEventListener("mousewheel",function(s){i.call(t,s.wheelDelta<0)},!1)},r=Math.PI,a=2*r,o=Math.sin,c=Math.cos,d=o(r/3),l=c(r/3),u=r/5,f=r/2.5;e.prototype={constructor:e,push:Array.prototype.push,init:function(){this.initCanvas(),this.initResizing(),this.initAudio(),this.initControls(),this.play()},initCanvas:function(){this.ctx=this.canvas.getContext("2d"),this.width=this.canvas.width,this.height=this.canvas.height,this.centerX=this.width/2,this.centerY=this.height/2,this.modes=["toWaves","toStars","toLines"],void 0===this.curMode&&(this.curMode=2),this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.titleFont='20px "Microsoft Yahei"',this.titleCenterY=15,this.infoAreaY=~~(this.height/12)+40,this.infoPlateColor=.5,this.btnSize=~~(this.height/36),this.btnSizeLarge=1.25*this.btnSize,this.btnIncre=.5*this.btnSize,this.btnIncreL=.5*this.btnSizeLarge,this.btnCenterY=this.btnSizeLarge+36,this.btnAddX=~~(this.width/8),this.btnPLX=this.btnAddX+4*this.btnSize,this.btnPrevX=this.centerX-~~(this.width/10),this.btnNextX=this.centerX+~~(this.width/10),this.btnListX=this.width-this.btnAddX,this.btnLineWidth=Math.min(~~(this.height/30),3),this.modeListX=this.btnListX-this.btnSizeLarge,this.modeListY=this.infoAreaY,this.modeListW=this.width-this.modeListX,this.modeListH=this.btnSizeLarge,this.initPlayList(),this.initVisualEffects()},initVisualEffects:function(){var t=this.ctx.createLinearGradient(0,this.height,0,this.infoAreaY),i=~~(this.width/60),e=~~(this.height/60);t.addColorStop(0,"#f2992e"),t.addColorStop(1,"#fe0066"),this.waveInterval=2,this.waveWidth=this.width/32,this.waveColWidth=this.waveWidth-this.waveInterval,this.waveMaxHeight=this.height-this.infoAreaY,this.waveColor=t,this.stars=[],this.starOriginSpeedX=s(-40,40)+10,this.starOriginSpeedY=s(-40,40)-10,this.starOriginX=this.centerX,this.starOriginY=this.centerY,this.starOriginZ=20*-this.perspective,this.starSpeedZ=~~(this.perspective/10),this.starSum=0,this.starSize=~~(this.height/30),this.starPosOffset=80*this.starSize,this.starGroupLimit=this.perspective/2,this.starOriginLimit=[10*this.starSize,this.width-10*this.starSize,this.infoAreaY,this.height-10*this.starSize],this.linesSetting={points:[],colors:[s(0,255),s(0,255),s(0,255)],factors:[1,1,1],trails:[],trailLimit:10,opIncre:.08};for(var h=0;6>h;h++)this.linesSetting.points.push({x:s(0,this.width),y:s(this.infoAreaY,this.height),speedX:s(-i,i),speedY:s(-e,e)})},initPlayList:function(){this.PLFont='20px "Microsoft Yahei"',this.PLFS=20,this.PLWidth=~~(this.width/4*3),this.PLHeight=60,this.PLBG="#333",this.PLBGHover="#f2992e",this.PLBGColor="#fff",this.PLBetween=3*this.PLHeight,this.PLData=[],this.perspective=1e3,this.speedAngle=0,this.distributePL()},initAudio:function(){this.audio=new Audio,this.aCtx=new(window.AudioContext||window.webkitAudioContext),this.source=this.aCtx.createMediaElementSource(this.audio),this.analyser=this.aCtx.createAnalyser(),this.analyser.fftSize=64,this.frqLength=32,this.frqData=new Uint8Array(this.analyser.frequencyBinCount),this.source.connect(this.analyser),this.source.connect(this.aCtx.destination),this.musicNames=[],this.initFileAdd();for(var t=0;t<this.musics.length;t++)this.musicNames.push(this.musics[t].replace(/.*[\\\/]/,""))},initFileAdd:function(){var t=this;this.input=document.createElement("input"),this.input.type="file",this.input.multiple=!0,this.input.addEventListener("change",function(){t.addMusic(this.files)},!1),this.canvas.addEventListener("dragover",function(t){t.preventDefault()},!1),this.canvas.addEventListener("drop",function(i){i.preventDefault(),t.addMusic([i.dataTransfer.files[0]])},!1)},initControls:function(){var t=this;this.canvas.addEventListener("mousemove",function(i){t.mouseX=i.offsetX,t.mouseY=i.offsetY},!1),this.canvas.addEventListener("click",function(i){t.hoveredTargetHandler?("btnListHandler"!==t.hoveredTargetHandler&&(t.modeListNeeded=!1),t[t.hoveredTargetHandler](t.hoveredTargetValue)):t.modeListNeeded=!1}),this.canvas.addEventListener("mousedown",function(s){function e(){this.pause()}function h(i){if(t.isProgressHintNeeded)if(o){var s=i.offsetY-a.y;a.y=i.offsetY,n+=0>s?.01:-.01,n>r&&(n=r)||0>n&&(n=0),t.audio.volume=n,t.progressMsg=~~(100*t.audio.volume)}else{var h=i.offsetX-a.x;a.x=i.offsetX,n+=0>h?-5:5,n>=r&&(n=r-1)||0>n&&(n=0),t.audio.currentTime=n,t.progressMsg=d(n/3600)+":"+d(n%3600/60)+":"+d(n%60)+"/"+d(r/3600)+":"+d(r%3600/60)+":"+d(r%60)}else{var h=i.offsetX-a.x,s=i.offsetY-a.y;if(200>h*h+s*s)return;t.isProgressHintNeeded=!0,Math.abs(h)<Math.abs(s)?(o=!0,n=c.volume,r=1,t.progressMsg="Volume"):(n=c.currentTime,r=c.duration,t.progressMsg="Progress",c.addEventListener("play",e,!1),c.pause())}}var n,r,a={x:s.offsetX,y:s.offsetY},o=!1,c=t.audio,d=i;this.addEventListener("mousemove",h,!1),document.addEventListener("mouseup",function l(){t.isProgressHintNeeded=!1,o||(c.removeEventListener("play",e,!1),c.play()),t.canvas.removeEventListener("mousemove",h,!1),document.removeEventListener("mouseup",l,!1)})}),n(this.canvas,function(i){t.speedAngle+=i?-.03:.03})},initResizing:function(){var i=this;t.addEventListener("resize",function(){i.initCanvas()},!1)},play:function(){var t=this;this.audio.addEventListener("canplay",function(){t.resetTitle(),this.play()},!1),this.audio.addEventListener("canplay",function i(){t.visualize(),t.audio.removeEventListener("canplay",i,!1)}),this.audio.addEventListener("ended",function(){t.switchMusic((t.curMusic+1)%t.musics.length)},!1),this.audio.addEventListener("error",function(){t.removeMusic()},!1),this.switchMusic(this.curMusic)},visualize:function(){var t=this;this.ctx.clearRect(0,0,this.width,this.height),this.hoveredTargetHandler=null,this.hoveredTargetValue=null,requestAnimationFrame(function(){t.visualize()}),this.isStopped?this.showError():(this[this.modes[this.curMode]](),this.showInfo(),this.isPlayListNeeded&&this.showPlayList(),this.modeListNeeded&&this.showModeList(),this.tipsNeeded&&this.showTips(),this.isProgressHintNeeded&&this.showProgressHint())},showError:function(){var t=this.ctx;t.beginPath(),t.fillStyle="#000",t.fillText(this.curMusicName,this.centerX,this.centerY)},drawInfoPlate:function(){var t=this.ctx;this.mouseY<=this.infoAreaY?(this.infoPlateColor+=.02,this.infoPlateColor>.8&&(this.infoPlateColor=.8),t.beginPath(),t.fillStyle="rgba(0,0,0,"+this.infoPlateColor+")",t.fillRect(0,0,this.width,this.infoAreaY)):(this.infoPlateColor>.5&&(this.infoPlateColor-=.02),t.beginPath(),t.fillStyle="rgba(0,0,0,"+this.infoPlateColor+")",t.fillRect(0,0,this.width,this.infoAreaY))},drawTitle:function(){var t,i=this.ctx,s=this.audio.currentTime/this.audio.duration;i.font=this.titleFont,this.audio.duration?(t=i.createLinearGradient(this.titleLeft,0,this.titleRight,0),t.addColorStop(0,"#fff"),t.addColorStop(s,"#fff"),t.addColorStop(s,"rgba(255,255,255,.5)")):t="rgba(255,255,255,.5)",i.beginPath(),i.fillStyle=t,i.fillText(this.curMusicName,this.centerX,this.titleCenterY)},resolveBtnHover:function(t,i,s){this.ctx.arc(i,this.btnCenterY,s,0,a,!1),this.ctx.isPointInPath(this.mouseX,this.mouseY)&&(this.hoveredTargetHandler=t,this.ctx.strokeStyle="#fff",this.ctx.fillStyle="#fff",this.ctx.shadowColor="#fff",this.ctx.shadowBlur=2)},drawBtnTriangle:function(t,i){this.ctx.beginPath(),this.ctx.moveTo(t-i,this.btnCenterY),this.ctx.lineTo(t+i*l,this.btnCenterY-i*d),this.ctx.lineTo(t+i*l,this.btnCenterY+i*d),this.ctx.closePath(),this.ctx.fill()},drawAddBtn:function(){var t=this.btnIncre,i=this.ctx;i.beginPath(),i.save(),this.resolveBtnHover("btnAddHandler",this.btnAddX,this.btnSizeLarge),i.moveTo(this.btnAddX-t,this.btnCenterY),i.lineTo(this.btnAddX+t,this.btnCenterY),i.moveTo(this.btnAddX,this.btnCenterY-t),i.lineTo(this.btnAddX,this.btnCenterY+t),i.stroke(),i.restore()},_drawPlayListBtn:function(t,i){var s=this.ctx;s.beginPath(),s.moveTo(this.btnPLX-t,i),s.arc(this.btnPLX-t,i,.8*s.lineWidth,0,a,!1),s.fill(),s.beginPath(),s.moveTo(this.btnPLX-.6*t,i),s.lineTo(this.btnPLX+t,i),s.stroke()},drawPlayListBtn:function(){var t=this.ctx,i=this.btnIncreL;t.beginPath(),t.save(),this.resolveBtnHover("btnPLHandler",this.btnPLX,this.btnSizeLarge),t.stroke(),this._drawPlayListBtn(i,this.btnCenterY-i),this._drawPlayListBtn(i,this.btnCenterY),this._drawPlayListBtn(i,this.btnCenterY+i),t.restore()},drawProgressBtns:function(){var t,i,s=this.ctx,e=this.btnIncre;s.beginPath(),s.save(),this.resolveBtnHover("btnPrevHandler",this.btnPrevX,this.btnSize),t=this.btnPrevX+.1*e,s.moveTo(t-e,this.btnCenterY-e),s.lineTo(t-e,this.btnCenterY+e),s.stroke(),this.drawBtnTriangle(t,e),s.restore(),s.beginPath(),s.save(),this.resolveBtnHover("btnNextHandler",this.btnNextX,this.btnSize),s.stroke(),s.beginPath(),t=this.btnNextX-.1*e,s.moveTo(t+e,this.btnCenterY-e),s.lineTo(t+e,this.btnCenterY+e),s.stroke(),this.drawBtnTriangle(t,-e),s.restore(),s.beginPath(),s.save(),this.resolveBtnHover("btnPlayHandler",this.centerX,this.btnSizeLarge),s.stroke(),s.beginPath(),this.isPaused?this.drawBtnTriangle(this.centerX,.5*-this.btnSizeLarge):(e=.3*this.btnSizeLarge,i=1.5*e,s.lineWidth=2*this.btnLineWidth,s.moveTo(this.centerX-e,this.btnCenterY-i),s.lineTo(this.centerX-e,this.btnCenterY+i),s.moveTo(this.centerX+e,this.btnCenterY-i),s.lineTo(this.centerX+e,this.btnCenterY+i),s.stroke()),s.restore()},drawListBtn:function(){var t=this.btnIncreL,i=this.ctx,s=.3*t;i.beginPath(),i.save(),this.resolveBtnHover("btnListHandler",this.btnListX,this.btnSizeLarge),i.stroke(),i.beginPath(),i.arc(this.btnListX-t,this.btnCenterY,s,0,a,!1),i.moveTo(this.btnListX,this.btnCenterY),i.arc(this.btnListX,this.btnCenterY,s,0,a,!1),i.moveTo(this.btnListX+t,this.btnCenterY),i.arc(this.btnListX+t,this.btnCenterY,s,0,a,!1),i.fill(),i.restore()},drawInfoButtons:function(){this.ctx.lineWidth=this.btnLineWidth,this.ctx.strokeStyle=this.infoPlateColor>.7?"#eee":"rgba(255,255,255,.4)",this.ctx.fillStyle=this.infoPlateColor>.7?"#eee":"rgba(255,255,255,.4)",this.drawAddBtn(),this.drawPlayListBtn(),this.drawProgressBtns(),this.drawListBtn()},btnAddHandler:function(){this.input.click()},btnPLHandler:function(){this.isPlayListNeeded=!this.isPlayListNeeded,this.speedAngle=0},btnPrevHandler:function(){this.switchMusic((this.curMusic+this.musics.length-1)%this.musics.length)},btnNextHandler:function(){this.switchMusic((this.curMusic+1)%this.musics.length)},btnPlayHandler:function(){this.isPaused?this.audio.play():this.audio.pause(),this.isPaused=!this.isPaused},btnListHandler:function(){this.modeListNeeded=!this.modeListNeeded},drawLi:function(t,i,s,e,h,n,r,a,o){var c=this.ctx;c.beginPath(),c.rect(s,e,h,n),c.isPointInPath(this.mouseX,this.mouseY)?(c.fillStyle=a,this.hoveredTargetHandler=o,this.hoveredTargetValue=t):c.fillStyle=r,c.fill(),c.fillStyle="#fff",c.fillText(i.replace("to",""),s+h/2,e+n/2)},showModeList:function(){for(var t=0;t<this.modes.length;t++)this.drawLi(t,this.modes[t],this.modeListX,this.modeListY+t*(this.modeListH+2),this.modeListW,this.modeListH,t===this.curMode?"#333":"rgba(0,0,0,.5)","#333","switchMode")},showTips:function(){var t,i=this.ctx;i.font='50px "Microsoft Yahei"',t=i.measureText(this.tipsMsg).width+80,i.beginPath(),i.save(),i.fillStyle="rgba(0,0,0,.8)",i.fillRect(this.centerX-t/2,this.centerY-40,t,80),i.fillStyle="#fff",i.fillText(this.tipsMsg,this.centerX,this.centerY),i.restore()},showInfo:function(){this.ctx;this.drawInfoPlate(),this.drawTitle(),this.drawInfoButtons()},distributePL:function(){var t,i,s,e,h,n=a/this.musics.length,r=this.perspective;this.PLRadius=~~(this.PLBetween/n),this.PLData=[];for(var d=0;d<this.musics.length;d++)t=d*n,i=this.PLRadius*c(t),y=this.PLRadius*o(t),h=r/(r-i),s=h*this.PLWidth,e=h*this.PLHeight,this.PLData[d]={angle:t,y:y,z:i,w:s,h:e,coordX:this.centerX-s/2,coordY:this.centerY-e/2-y,font:h*this.PLFS,idx:(d+this.curMusic)%this.musics.length}},findClosest:function(t,i){for(var s,e=t.length-1;e>=0;e--)if(s=t[e],this.ctx.beginPath(),this.ctx.rect(s.coordX,s.coordY,s.w,s.h),this.ctx.isPointInPath(this.mouseX,this.mouseY))return this.hoveredTargetHandler="switchMusic",this.hoveredTargetValue=s.idx,e},handlePLSpeed:function(){this.speedAngle*=.98},calcPLLoc:function(t){if(Math.abs(this.speedAngle)>.001){var i,s=this.speedAngle,e=this.perspective;t.angle+=s,i=c(s)*t.z-o(s)*t.y,t.y=c(s)*t.y+o(s)*t.z,t.z=i,e/=e-i,t.w=e*this.PLWidth,t.h=e*this.PLHeight,t.coordX=this.centerX-t.w/2,t.coordY=this.centerY-t.h/2-t.y,t.font=this.PLFS*e}},drawPLLi:function(t,i,s,e,h,n,r){var a=this.ctx;a.beginPath(),a.rect(i,s,e,h),a.fillStyle=n,a.fill(),a.fillStyle="#fff",a.font=r,a.fillText(t.replace("to",""),i+e/2,s+h/2)},showPlayList:function(){var t,i;this.handlePLSpeed(),this.PLData.sort(function(t,i){return t.z-i.z}),i=this.findClosest(this.PLData);for(var s=0;s<this.PLData.length;s++)t=this.PLData[s],this.calcPLLoc(t),this.drawPLLi(this.musicNames[t.idx],t.coordX,t.coordY,t.w,t.h,s===i?"#f2992e":"#333",t.font+'px "Microsoft Yahei"')},showProgressHint:function(){var t=this.ctx;t.beginPath(),t.fillStyle="#333",t.font=this.PLFont,t.fillText(this.progressMsg,this.mouseX,this.mouseY)},drawStar:function(t,i,s,e,h){var n,r=this.ctx;r.save(),r.beginPath(),r.moveTo(t,i-e);for(var a=0;5>a;a++)n=a*f+u,r.lineTo(t+o(n)*s,i-c(n)*s),n=(a+1)*f,r.lineTo(t+o(n)*e,i-c(n)*e);r.fillStyle=h,r.fill(),r.restore()},drawStars:function(){for(var t,i,s,e,h=[],n=this.perspective,r=0;r<this.stars.length;r++)if(t=this.stars[r],s=t[0],s.z+=this.starSpeedZ,s.z<this.starGroupLimit){s.x+=s.speedX,s.y+=s.speedY,e=n/(n-s.z),h.push(t);for(var a=1;a<t.length;a++)i=t[a],this.drawStar(i.x*e+s.x,i.y*e+s.y,this.starSize*e,this.starSize*e*2.5,i.color)}this.stars=h},starOriginMove:function(){this.starOriginX+=this.starOriginSpeedX,(this.starOriginX<=this.starOriginLimit[0]||this.starOriginX>=this.starOriginLimit[1])&&(this.starOriginSpeedX*=-1,this.starOriginSpeedX+=s(-4,4)),this.starOriginY+=this.starOriginSpeedY,(this.starOriginY<=this.starOriginLimit[2]||this.starOriginY>=this.starOriginLimit[3])&&(this.starOriginSpeedY*=-1,this.starOriginSpeedX+=s(-4,4))},justifyPointSpeed:function(t){t.x<=0?(t.x=0,t.speedX*=-1):t.x>=this.width&&(t.x=this.width,t.speedX*=-1),t.y<=this.infoAreaY?(t.y=this.infoAreaY,t.speedY*=-1):t.y>=this.height&&(t.y=this.height,t.speedY*=-1)},toWaves:function(){var t,i=this.ctx,s=this.waveInterval/2,e=s+this.waveColWidth/2;this.analyser.getByteFrequencyData(this.frqData),i.beginPath(),i.save(),i.lineWidth=this.waveColWidth,i.strokeStyle=this.waveColor;for(var h=0;h<this.frqLength;h++)t=e+this.waveWidth*h,i.moveTo(t,this.height),i.lineTo(t,this.height-this.waveMaxHeight*this.frqData[h]/255);i.stroke(),i.restore()},toStars:function(){var t,i=0;if(this.analyser.getByteFrequencyData(this.frqData),i+=this.frqData[4]+this.frqData[10]+this.frqData[20],i-this.starSum>20){this.starOriginMove(),t=[{x:this.starOriginX,y:this.starOriginY,z:this.starOriginZ,speedX:(this.centerX-this.starOriginX)/180,speedY:(this.centerY-this.starOriginY)/180}];for(var e=0;12>e;e++)t.push({x:s(-this.starPosOffset,this.starPosOffset),y:s(-this.starPosOffset,this.starPosOffset),color:Math.random()>.5?"#f2992e":Math.random()<.5?"#fe0066":"#529ecc"});this.stars.unshift(t)}this.starSum=i,this.drawStars()},toLines:function(){var t,i,s,e=this.linesSetting,h=this.ctx,n=[];h.save(),h.fillStyle="#000",h.fillRect(0,0,this.width,this.height),h.lineWidth=1,this.analyser.getByteFrequencyData(this.frqData);for(var r=0;r<e.trails.length;r++){h.beginPath(),i=e.trails[r],h.strokeStyle=i[0].replace("op",(r+1)*e.opIncre),h.moveTo(i[1].x,i[1].y);for(var a=2;a<i.length;a++)h.lineTo(i[a].x,i[a].y);h.closePath(),h.stroke()}n[0]=~~((this.frqData[0]+this.frqData[2]+this.frqData[5])/3/30),n[1]=~~((this.frqData[10]+this.frqData[12]+this.frqData[14])/3/30),n[2]=~~((this.frqData[20]+this.frqData[22]+this.frqData[25])/3/30);for(var r=0;3>r;r++)e.colors[r]+=e.factors[r]*n[r],e.colors[r]>255?(e.colors[r]=255,e.factors[r]*=-1):e.colors[r]<0&&(e.colors[r]=0,e.factors[r]*=-1);s=(n[0]+n[1]+n[2])/3/2,i=[],i.push("rgba("+e.colors[0]+","+e.colors[1]+","+e.colors[2]+",op)"),t=e.points[0],h.beginPath(),t.x+=t.speedX,t.y+=t.speedY,this.justifyPointSpeed(t),h.beginPath(),h.moveTo(t.x,t.y),i.push({x:t.x,y:t.y});for(var r=1;r<e.points.length;r++)t=e.points[r],t.x+=t.speedX*s,t.y+=t.speedY*s,this.justifyPointSpeed(t),h.lineTo(t.x,t.y),i.push({x:t.x,y:t.y});h.closePath(),h.stroke(),e.trails.push(i),e.trails.length>e.trailLimit&&e.trails.shift(),h.restore()},toVortex:function(){},addMusic:function(t){for(var i=this.musics.length,s=0;s<t.length;s++)/audio/.test(t[s].type)&&(this.musics.push(URL.createObjectURL(t[s])),this.musicNames.push(t[s].name));this.isStopped&&this.switchMusic(i),this.distributePL()},removeMusic:function(){var i=this;this.tipsNeeded=!0,this.tipsMsg="浏览器不支持文件 "+this.musicNames[this.curMusic],t.clearTimeout(this.tipTimer),this.tipTimer=t.setTimeout(function(){i.tipsNeeded=!1},2e3),this.musics.splice(this.curMusic,1),this.musicNames.splice(this.curMusic,1),this.musics.length?this.switchMusic((this.curMusic+1)%this.musics.length):(this.curMusicName="No music available!",this.isStopped=!0),this.distributePL()},switchMode:function(t){this.curMode=t},switchMusic:function(t){this.isStopped=!1,this.audio.src=this.musics[t],this.curMusic=t,this.curMusicName="Loading...",this.isPlayListNeeded||this.distributePL()},resetTitle:function(){this.curMusicName=this.musicNames[this.curMusic],this.ctx.font=this.titleFont,this.titleWidth=this.ctx.measureText(this.curMusicName).width,this.titleLeft=(this.width-this.titleWidth)/2,this.titleRight=this.titleWidth+this.titleLeft}},t.SimplePlayer=e}(window);